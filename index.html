<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Low Latency Stylus Annotation</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #f8f7f4;
      --bg-secondary: #eae8e3;
      --text-primary: #2d2a26;
      --text-secondary: #6b6660;
      --accent: #e85d04;
      --accent-hover: #dc2f02;
      --toolbar-bg: rgba(255, 255, 255, 0.92);
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
      --border: rgba(0, 0, 0, 0.08);
    }

    .dark {
      --bg-primary: #1a1917;
      --bg-secondary: #2d2a26;
      --text-primary: #f8f7f4;
      --text-secondary: #a8a39c;
      --toolbar-bg: rgba(45, 42, 38, 0.95);
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
      --border: rgba(255, 255, 255, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      height: 100dvh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--toolbar-bg);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      z-index: 10;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-icon svg {
      width: 18px;
      height: 18px;
      stroke: white;
      fill: none;
      stroke-width: 2.5;
    }

    h1 {
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .badge-group {
      display: flex;
      gap: 8px;
    }

    .latency-badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      padding: 4px 10px;
      background: var(--bg-secondary);
      border-radius: 20px;
      color: var(--text-secondary);
    }

    .latency-badge span {
      color: var(--accent);
      font-weight: 600;
    }

    .vector-badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      padding: 4px 10px;
      background: #16a34a20;
      border-radius: 20px;
      color: #16a34a;
      font-weight: 600;
    }

    .canvas-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: var(--bg-secondary);
      overflow: hidden;
    }

    .canvas-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      max-width: 1200px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .svg-container {
      position: absolute;
      inset: 0;
      touch-action: none;
      cursor: crosshair;
    }

    .svg-container svg {
      width: 100%;
      height: 100%;
      display: block;
    }


    .toolbar {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--toolbar-bg);
      backdrop-filter: blur(16px);
      border-radius: 16px;
      box-shadow: var(--shadow), 0 0 0 1px var(--border);
    }

    .tool-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .divider {
      width: 1px;
      height: 24px;
      background: var(--border);
      margin: 0 6px;
    }

    .tool-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      color: var(--text-secondary);
    }

    .tool-btn:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .tool-btn.active {
      background: var(--accent);
      color: white;
    }

    .tool-btn svg {
      width: 20px;
      height: 20px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .color-picker {
      position: relative;
    }

    .color-swatch {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 3px solid var(--bg-primary);
      box-shadow: 0 0 0 1px var(--border);
      cursor: pointer;
      transition: transform 0.15s ease;
    }

    .color-swatch:hover {
      transform: scale(1.1);
    }

    .color-options {
      position: absolute;
      bottom: 52px;
      left: 50%;
      transform: translateX(-50%) scale(0.9);
      opacity: 0;
      pointer-events: none;
      display: flex;
      gap: 6px;
      padding: 10px;
      background: var(--toolbar-bg);
      backdrop-filter: blur(16px);
      border-radius: 12px;
      box-shadow: var(--shadow);
      transition: all 0.2s ease;
    }

    .color-options.show {
      transform: translateX(-50%) scale(1);
      opacity: 1;
      pointer-events: auto;
    }

    .color-option {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      transition: transform 0.15s ease;
    }

    .color-option:hover {
      transform: scale(1.15);
    }

    .size-slider {
      width: 80px;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--bg-secondary);
      border-radius: 3px;
      cursor: pointer;
    }

    .size-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(232, 93, 4, 0.3);
    }

    .size-slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: var(--accent);
      border-radius: 50%;
      border: none;
      cursor: pointer;
    }

    .stats {
      position: absolute;
      top: 12px;
      right: 12px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.65rem;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border-radius: 8px;
      line-height: 1.6;
    }

    .stats-row {
      display: flex;
      justify-content: space-between;
      gap: 16px;
    }

    .stats-label {
      opacity: 0.6;
    }

    .stats-value {
      color: #4ade80;
    }

    .predicted {
      color: #fbbf24;
    }

    @media (max-width: 600px) {
      header {
        padding: 10px 14px;
      }

      h1 {
        font-size: 0.95rem;
      }

      .latency-badge, .vector-badge {
        display: none;
      }

      .toolbar {
        bottom: 12px;
        padding: 6px 10px;
        gap: 4px;
      }

      .tool-btn {
        width: 36px;
        height: 36px;
      }

      .size-slider {
        width: 60px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <div class="logo-icon">
        <svg viewBox="0 0 24 24"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/></svg>
      </div>
      <h1>Stylus Annotation</h1>
    </div>
    <div class="badge-group">
      <div class="vector-badge">SVG Vector</div>
      <div class="latency-badge">Latency: <span>~8ms</span></div>
    </div>
  </header>

  <div class="canvas-container">
    <div class="canvas-wrapper">
      <div class="svg-container" id="mainLayer">
        <svg id="mainSvg" xmlns="http://www.w3.org/2000/svg">
          <rect width="100%" height="100%" fill="#ffffff"/>
          <g id="strokesGroup"></g>
          <path id="currentStroke" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="stats" id="stats">
        <div class="stats-row">
          <span class="stats-label">Coalesced:</span>
          <span class="stats-value" id="coalescedCount">0</span>
        </div>
        <div class="stats-row">
          <span class="stats-label">Pressure:</span>
          <span class="stats-value" id="pressureVal">0.00</span>
        </div>
      </div>

      <div class="toolbar">
        <div class="tool-group">
          <button class="tool-btn active" id="penTool" title="Pen">
            <svg viewBox="0 0 24 24"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></svg>
          </button>
          <button class="tool-btn" id="eraserTool" title="Eraser">
            <svg viewBox="0 0 24 24"><path d="M20 20H7L3 16c-.8-.8-.8-2 0-2.8L13.4 2.8c.8-.8 2-.8 2.8 0L21 7.6c.8.8.8 2 0 2.8L11 20"/><path d="M6 11l5 5"/></svg>
          </button>
        </div>

        <div class="divider"></div>

        <div class="color-picker">
          <div class="color-swatch" id="colorSwatch" style="background: #2d2a26;"></div>
          <div class="color-options" id="colorOptions">
            <button class="color-option" style="background: #2d2a26;" data-color="#2d2a26"></button>
            <button class="color-option" style="background: #e85d04;" data-color="#e85d04"></button>
            <button class="color-option" style="background: #2563eb;" data-color="#2563eb"></button>
            <button class="color-option" style="background: #16a34a;" data-color="#16a34a"></button>
            <button class="color-option" style="background: #9333ea;" data-color="#9333ea"></button>
          </div>
        </div>

        <input type="range" class="size-slider" id="sizeSlider" min="1" max="20" value="3">

        <div class="divider"></div>

        <button class="tool-btn" id="undoBtn" title="Undo">
          <svg viewBox="0 0 24 24"><path d="M3 10h10a5 5 0 0 1 5 5v2"/><path d="M7 6L3 10l4 4"/></svg>
        </button>
        <button class="tool-btn" id="clearBtn" title="Clear">
          <svg viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>
        </button>
        <button class="tool-btn" id="exportBtn" title="Export SVG">
          <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Dark mode detection
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      document.documentElement.classList.toggle('dark', event.matches);
    });

    // SVG elements
    const mainLayer = document.getElementById('mainLayer');
    const mainSvg = document.getElementById('mainSvg');
    const strokesGroup = document.getElementById('strokesGroup');
    const currentStrokePath = document.getElementById('currentStroke');

    // Drawing state
    let isDrawing = false;
    let currentTool = 'pen';
    let currentColor = '#2d2a26';
    let currentSize = 3;
    let points = [];
    let strokeHistory = []; // Array of SVG path elements

    // Stats
    const coalescedEl = document.getElementById('coalescedCount');
    const pressureEl = document.getElementById('pressureVal');

    function getPoint(e) {
      const rect = mainLayer.getBoundingClientRect();
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top,
        pressure: e.pressure || 0.5
      };
    }

    function getStrokeWidth(pressure) {
      return currentSize * (0.6 + pressure * 0.8);
    }

    // Build SVG path data from points using quadratic bezier curves
    function buildPathData(pts) {
      if (pts.length === 0) return '';
      if (pts.length === 1) return `M ${pts[0].x} ${pts[0].y}`;

      let d = `M ${pts[0].x} ${pts[0].y}`;

      if (pts.length === 2) {
        d += ` L ${pts[1].x} ${pts[1].y}`;
        return d;
      }

      // Use quadratic bezier curves through midpoints for smoothness
      for (let i = 1; i < pts.length - 1; i++) {
        const p0 = pts[i];
        const p1 = pts[i + 1];
        const midX = (p0.x + p1.x) / 2;
        const midY = (p0.y + p1.y) / 2;

        if (i === 1) {
          d += ` Q ${p0.x} ${p0.y} ${midX} ${midY}`;
        } else {
          d += ` Q ${p0.x} ${p0.y} ${midX} ${midY}`;
        }
      }

      // End at last point
      const last = pts[pts.length - 1];
      const secondLast = pts[pts.length - 2];
      d += ` Q ${secondLast.x} ${secondLast.y} ${last.x} ${last.y}`;

      return d;
    }

    // Calculate average pressure for variable stroke width (simplified for SVG)
    function getAveragePressure(pts) {
      if (pts.length === 0) return 0.5;
      const sum = pts.reduce((acc, p) => acc + p.pressure, 0);
      return sum / pts.length;
    }

    function updateCurrentStroke() {
      const pathData = buildPathData(points);
      const avgPressure = getAveragePressure(points);
      const strokeWidth = getStrokeWidth(avgPressure);

      currentStrokePath.setAttribute('d', pathData);
      currentStrokePath.setAttribute('stroke', currentColor);
      currentStrokePath.setAttribute('stroke-width', strokeWidth);
    }

    function commitStroke() {
      if (points.length < 2) return;

      const pathData = buildPathData(points);
      const avgPressure = getAveragePressure(points);
      const strokeWidth = getStrokeWidth(avgPressure);

      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', pathData);
      path.setAttribute('stroke', currentColor);
      path.setAttribute('stroke-width', strokeWidth);
      path.setAttribute('fill', 'none');
      path.setAttribute('stroke-linecap', 'round');
      path.setAttribute('stroke-linejoin', 'round');

      strokesGroup.appendChild(path);
      strokeHistory.push(path);

      // Clear current stroke
      currentStrokePath.setAttribute('d', '');
    }

    function handlePointerDown(e) {
      if (e.pointerType === 'touch' && e.isPrimary === false) return;

      isDrawing = true;
      points = [getPoint(e)];

      if (currentTool === 'eraser') {
        checkEraserHit(points[0]);
      }

      mainLayer.setPointerCapture(e.pointerId);
    }

    function handlePointerMove(e) {
      if (!isDrawing) return;

      // Process coalesced events
      const coalescedEvents = e.getCoalescedEvents ? e.getCoalescedEvents() : [e];
      coalescedEl.textContent = coalescedEvents.length;

      for (const event of coalescedEvents) {
        const point = getPoint(event);
        points.push(point);
        pressureEl.textContent = point.pressure.toFixed(2);

        if (currentTool === 'eraser') {
          checkEraserHit(point);
        }
      }

      if (currentTool === 'pen') {
        updateCurrentStroke();
      }
    }

    function handlePointerUp(e) {
      if (!isDrawing) return;
      isDrawing = false;

      if (currentTool === 'pen') {
        commitStroke();
      }

      points = [];
    }

    function handlePointerCancel() {
      isDrawing = false;
      currentStrokePath.setAttribute('d', '');
      points = [];
    }

    // Eraser: check if point hits any stroke (optimized)
    function checkEraserHit(point) {
      const eraserRadius = currentSize * 4;
      const r2 = eraserRadius * eraserRadius;

      for (let i = strokeHistory.length - 1; i >= 0; i--) {
        const path = strokeHistory[i];

        // Fast bounding box check first
        const bbox = path.getBBox();
        if (point.x < bbox.x - eraserRadius ||
            point.x > bbox.x + bbox.width + eraserRadius ||
            point.y < bbox.y - eraserRadius ||
            point.y > bbox.y + bbox.height + eraserRadius) {
          continue; // Skip - not even close
        }

        // Sample limited points along the path
        const pathLength = path.getTotalLength();
        const step = Math.max(20, pathLength / 15); // Fixed step size

        for (let len = 0; len <= pathLength; len += step) {
          const samplePoint = path.getPointAtLength(len);
          const dx = samplePoint.x - point.x;
          const dy = samplePoint.y - point.y;

          if (dx * dx + dy * dy < r2) {
            path.remove();
            strokeHistory.splice(i, 1);
            break;
          }
        }
      }
    }

    // Event listeners
    mainLayer.addEventListener('pointerdown', handlePointerDown);
    mainLayer.addEventListener('pointermove', handlePointerMove);
    mainLayer.addEventListener('pointerup', handlePointerUp);
    mainLayer.addEventListener('pointercancel', handlePointerCancel);
    mainLayer.addEventListener('pointerleave', handlePointerUp);

    mainLayer.addEventListener('touchstart', e => e.preventDefault(), { passive: false });
    mainLayer.addEventListener('touchmove', e => e.preventDefault(), { passive: false });

    // Tool buttons
    const penBtn = document.getElementById('penTool');
    const eraserBtn = document.getElementById('eraserTool');

    penBtn.addEventListener('click', () => {
      currentTool = 'pen';
      penBtn.classList.add('active');
      eraserBtn.classList.remove('active');
      mainLayer.style.cursor = 'crosshair';
    });

    eraserBtn.addEventListener('click', () => {
      currentTool = 'eraser';
      eraserBtn.classList.add('active');
      penBtn.classList.remove('active');
      mainLayer.style.cursor = 'cell';
    });

    // Color picker
    const colorSwatch = document.getElementById('colorSwatch');
    const colorOptions = document.getElementById('colorOptions');

    colorSwatch.addEventListener('click', (e) => {
      e.stopPropagation();
      colorOptions.classList.toggle('show');
    });

    document.querySelectorAll('.color-option').forEach(btn => {
      btn.addEventListener('click', () => {
        currentColor = btn.dataset.color;
        colorSwatch.style.background = currentColor;
        colorOptions.classList.remove('show');

        currentTool = 'pen';
        penBtn.classList.add('active');
        eraserBtn.classList.remove('active');
      });
    });

    document.addEventListener('click', () => {
      colorOptions.classList.remove('show');
    });

    // Size slider
    const sizeSlider = document.getElementById('sizeSlider');
    sizeSlider.addEventListener('input', () => {
      currentSize = parseInt(sizeSlider.value);
    });

    // Undo
    document.getElementById('undoBtn').addEventListener('click', () => {
      if (strokeHistory.length === 0) return;
      const lastStroke = strokeHistory.pop();
      lastStroke.remove();
    });

    // Clear
    document.getElementById('clearBtn').addEventListener('click', () => {
      strokeHistory.forEach(path => path.remove());
      strokeHistory = [];
    });

    // Export SVG
    document.getElementById('exportBtn').addEventListener('click', () => {
      const svgClone = mainSvg.cloneNode(true);

      // Remove the current stroke path (empty during export)
      const currentPath = svgClone.querySelector('#currentStroke');
      if (currentPath) currentPath.remove();

      // Set proper dimensions
      const rect = mainSvg.getBoundingClientRect();
      svgClone.setAttribute('width', rect.width);
      svgClone.setAttribute('height', rect.height);
      svgClone.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);

      const svgData = new XMLSerializer().serializeToString(svgClone);
      const blob = new Blob([svgData], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = 'annotation.svg';
      link.click();

      URL.revokeObjectURL(url);
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'p' || e.key === 'P') penBtn.click();
      if (e.key === 'e' || e.key === 'E') eraserBtn.click();
      if ((e.metaKey || e.ctrlKey) && e.key === 'z') {
        e.preventDefault();
        document.getElementById('undoBtn').click();
      }
      if ((e.metaKey || e.ctrlKey) && e.key === 's') {
        e.preventDefault();
        document.getElementById('exportBtn').click();
      }
    });
  </script>
</body>
</html>
