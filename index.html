<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Delegated Ink Trail</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: #ffffff;
    }

    .dark body {
      background-color: #ffffff;
    }

    canvas {
      display: block;
      touch-action: none;
    }

    #instructions {
      position: fixed;
      bottom: 1.5rem;
      left: 50%;
      transform: translateX(-50%);
      font-family: 'Segoe UI', system-ui, sans-serif;
      font-size: 13px;
      color: rgba(0, 0, 0, 0.5);
      text-align: center;
      pointer-events: none;
      user-select: none;
    }

    .dark #instructions {
      color: rgba(0, 0, 0, 0.5);
    }

    #eraser-cursor {
      position: fixed;
      top: 0;
      left: 0;
      width: 20px;
      height: 20px;
      border: 1px solid #000;
      border-radius: 50%;
      pointer-events: none;
      display: none;
      will-change: transform;
      z-index: 9999;
    }

    #menu-toggle {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 6px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 0 0 4px 4px;
      cursor: pointer;
      z-index: 10000;
      transition: background 0.2s;
    }

    #menu-toggle:hover {
      background: rgba(0, 0, 0, 0.4);
    }

    #menu {
      position: fixed;
      top: -60px;
      left: 0;
      right: 0;
      height: 60px;
      background: rgba(255, 255, 255, 0.95);
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding: 0 16px;
      z-index: 9998;
      transition: top 0.3s ease;
      font-family: 'Segoe UI', system-ui, sans-serif;
      font-size: 13px;
    }

    #menu.open {
      top: 0;
    }

    #menu-toggle.menu-open {
      top: 60px;
    }

    .menu-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .menu-group label {
      color: #555;
      font-weight: 500;
    }

    .size-stepper {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .size-btn {
      width: 28px;
      height: 28px;
      border: 1px solid #ccc;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }

    .size-btn:hover {
      background: #eee;
    }

    .size-btn:active {
      background: #ddd;
    }

    #pen-size-display {
      min-width: 42px;
      text-align: center;
      font-weight: 500;
      color: #333;
    }

    #color-picker-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid #333;
      cursor: pointer;
      background: #000000;
      transition: transform 0.15s;
    }

    #color-picker-btn:hover {
      transform: scale(1.1);
    }

    #color-input,
    #trail-color-input {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
      pointer-events: none;
    }

    #trail-color-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid #333;
      cursor: pointer;
      background: #ff0000;
      transition: transform 0.15s;
    }

    #trail-color-btn:hover {
      transform: scale(1.1);
    }

    #clear-btn {
      padding: 6px 14px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: background 0.2s;
    }

    #clear-btn:hover {
      background: #c0392b;
    }

    .toggle-switch {
      position: relative;
      width: 36px;
      height: 20px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.2s;
      border-radius: 20px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.2s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: #e74c3c;
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(16px);
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <div id="eraser-cursor"></div>

  <div id="menu-toggle"></div>
  <div id="menu">
    <div class="menu-group">
      <label>Min</label>
      <div class="size-stepper">
        <button class="size-btn" id="min-size-down">−</button>
        <span id="min-size-display">0.50</span>
        <button class="size-btn" id="min-size-up">+</button>
      </div>
    </div>
    <div class="menu-group">
      <label>Max</label>
      <div class="size-stepper">
        <button class="size-btn" id="size-down">−</button>
        <span id="pen-size-display">5</span>
        <button class="size-btn" id="size-up">+</button>
      </div>
    </div>
    <div class="menu-group">
      <label>Color</label>
      <button id="color-picker-btn"></button>
      <input type="color" id="color-input" value="#000000">
    </div>
    <button id="clear-btn">Clear</button>
    <div class="menu-group">
      <label>Trail</label>
      <button id="trail-color-btn"></button>
      <input type="color" id="trail-color-input" value="#ff0000">
      <label class="toggle-switch">
        <input type="checkbox" id="trail-toggle" checked>
        <span class="toggle-slider"></span>
      </label>
    </div>
  </div>

  <div id="instructions">Draw with pen tip • Erase with pen eraser or right-click</div>

  <script>
    // Dark mode detection
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      if (event.matches) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    });

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const eraserCursor = document.getElementById('eraser-cursor');
    const menuToggle = document.getElementById('menu-toggle');
    const menu = document.getElementById('menu');
    const sizeDown = document.getElementById('size-down');
    const sizeUp = document.getElementById('size-up');
    const penSizeDisplay = document.getElementById('pen-size-display');
    const minSizeDown = document.getElementById('min-size-down');
    const minSizeUp = document.getElementById('min-size-up');
    const minSizeDisplay = document.getElementById('min-size-display');
    const colorPickerBtn = document.getElementById('color-picker-btn');
    const colorInput = document.getElementById('color-input');
    const clearBtn = document.getElementById('clear-btn');
    const trailToggle = document.getElementById('trail-toggle');
    const trailColorBtn = document.getElementById('trail-color-btn');
    const trailColorInput = document.getElementById('trail-color-input');

    const presenter = navigator.ink.requestPresenter({ presentationArea: canvas });
    let isDrawing = false;
    let isErasing = false;
    let lastX = 0;
    let lastY = 0;
    let prevX = 0;
    let prevY = 0;
    let smoothedPressure = 0.5;
    const PRESSURE_SMOOTHING = 0.12; // Lower = smoother (0-1)

    // Stroke settings
    let penColor = '#000000';
    let trailColor = '#ff0000';
    let penMaxSize = 5;
    let minStrokeWidth = 0.50;

    // Menu toggle
    menuToggle.addEventListener('click', () => {
      menu.classList.toggle('open');
      menuToggle.classList.toggle('menu-open');
    });

    // Pen size step controls
    const MIN_PEN_SIZE = 0.5;
    const MAX_PEN_SIZE = 20;
    const SIZE_STEP = 0.5;
    const MIN_SIZE_STEP = 0.05;
    const MIN_SIZE_LOWER = 0.05;
    const MIN_SIZE_UPPER = 2;

    function updateSizeDisplay() {
      penSizeDisplay.textContent = penMaxSize % 1 === 0 ? penMaxSize : penMaxSize.toFixed(1);
    }

    function updateMinSizeDisplay() {
      minSizeDisplay.textContent = minStrokeWidth.toFixed(2);
    }

    sizeDown.addEventListener('click', () => {
      penMaxSize = Math.max(MIN_PEN_SIZE, penMaxSize - SIZE_STEP);
      updateSizeDisplay();
    });

    sizeUp.addEventListener('click', () => {
      penMaxSize = Math.min(MAX_PEN_SIZE, penMaxSize + SIZE_STEP);
      updateSizeDisplay();
    });

    minSizeDown.addEventListener('click', () => {
      minStrokeWidth = Math.max(MIN_SIZE_LOWER, minStrokeWidth - MIN_SIZE_STEP);
      updateMinSizeDisplay();
    });

    minSizeUp.addEventListener('click', () => {
      minStrokeWidth = Math.min(MIN_SIZE_UPPER, minStrokeWidth + MIN_SIZE_STEP);
      updateMinSizeDisplay();
    });

    // Color picker
    colorPickerBtn.addEventListener('click', () => {
      colorInput.click();
    });

    colorInput.addEventListener('input', (e) => {
      penColor = e.target.value;
      colorPickerBtn.style.background = penColor;
    });

    // Trail color picker
    trailColorBtn.addEventListener('click', () => {
      trailColorInput.click();
    });

    trailColorInput.addEventListener('input', (e) => {
      trailColor = e.target.value;
      trailColorBtn.style.background = trailColor;
    });

    // Clear canvas
    clearBtn.addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    // Eraser size management
    const ERASER_BASE_SIZE = 20;
    const ERASER_LARGE_SIZE = 80;
    let eraserSize = ERASER_BASE_SIZE;
    let eraserTapCount = 0;
    let lastEraserTapTime = 0;
    const TAP_TIMEOUT = 500; // ms between taps to count as consecutive

    // Set up stroke style
    ctx.strokeStyle = penColor;
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      // Restore stroke style after resize (canvas reset clears it)
      ctx.strokeStyle = penColor;
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
    }

    // Prevent context menu on right-click
    canvas.addEventListener('contextmenu', (evt) => evt.preventDefault());

    function checkEraser(evt) {
      // Multiple detection methods for stylus eraser:
      // 1. button 5 = eraser button
      // 2. buttons bitmask 32 = eraser
      // 3. pointerType "eraser" (some devices)
      // 4. right-click (button 2) for mouse fallback
      return evt.button === 5 ||
             evt.button === 2 ||
             (evt.buttons & 32) !== 0 ||
             evt.pointerType === 'eraser';
    }

    function updateEraserCursor(x, y) {
      const offset = eraserSize / 2;
      eraserCursor.style.width = eraserSize + 'px';
      eraserCursor.style.height = eraserSize + 'px';
      eraserCursor.style.transform = `translate(${x - offset}px, ${y - offset}px)`;
      eraserCursor.style.borderColor = eraserSize === ERASER_LARGE_SIZE ? 'red' : '#000';
    }

    canvas.addEventListener('pointerdown', (evt) => {
      // Only allow pen/stylus input, not finger touch
      if (evt.pointerType === 'touch') return;

      isDrawing = true;
      isErasing = checkEraser(evt);
      lastX = evt.pageX;
      lastY = evt.pageY;
      prevX = evt.pageX;
      prevY = evt.pageY;
      smoothedPressure = evt.pressure > 0 ? evt.pressure : 0.5;

      if (isErasing) {
        // Track eraser taps for size toggle
        const now = Date.now();
        if (now - lastEraserTapTime < TAP_TIMEOUT) {
          eraserTapCount++;
        } else {
          eraserTapCount = 1;
        }
        lastEraserTapTime = now;

        // Toggle eraser size after 3 taps
        if (eraserTapCount >= 3) {
          eraserSize = eraserSize === ERASER_BASE_SIZE ? ERASER_LARGE_SIZE : ERASER_BASE_SIZE;
          eraserTapCount = 0;
        }

        eraserCursor.style.display = 'block';
        updateEraserCursor(evt.pageX, evt.pageY);
      }
    });

    canvas.addEventListener('pointerup', () => {
      // Reset large eraser back to normal when stylus leaves screen
      if (isErasing && eraserSize === ERASER_LARGE_SIZE) {
        eraserSize = ERASER_BASE_SIZE;
      }
      isDrawing = false;
      isErasing = false;
      eraserCursor.style.display = 'none';
      ctx.globalCompositeOperation = 'source-over';
    });

    canvas.addEventListener('pointerleave', () => {
      isDrawing = false;
      isErasing = false;
      eraserCursor.style.display = 'none';
      ctx.globalCompositeOperation = 'source-over';
    });

    canvas.addEventListener('pointermove', async (evt) => {
      if (!isDrawing) return;

      // Calculate midpoint for smooth quadratic curve
      const midX = (lastX + evt.pageX) / 2;
      const midY = (lastY + evt.pageY) / 2;

      ctx.beginPath();
      ctx.moveTo(prevX, prevY);
      ctx.quadraticCurveTo(lastX, lastY, midX, midY);

      // Get pressure (0-1), default to 0.5 for devices without pressure
      const rawPressure = evt.pressure > 0 ? evt.pressure : 0.5;
      // Apply pressure curve for more dramatic taper (power of 2)
      const curvedPressure = Math.pow(rawPressure, 2);
      // Smooth pressure to prevent stepped changes
      smoothedPressure = smoothedPressure + (curvedPressure - smoothedPressure) * PRESSURE_SMOOTHING;

      if (isErasing) {
        ctx.globalCompositeOperation = 'destination-out';
        ctx.lineWidth = eraserSize;
        updateEraserCursor(evt.pageX, evt.pageY);
      } else {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = penColor;
        // Apply smoothed pressure to stroke width
        ctx.lineWidth = minStrokeWidth + smoothedPressure * (penMaxSize - minStrokeWidth);
      }

      ctx.stroke();

      prevX = midX;
      prevY = midY;
      lastX = evt.pageX;
      lastY = evt.pageY;

      // Update ink trail if enabled
      if (trailToggle.checked) {
        const pressureDiameter = minStrokeWidth + smoothedPressure * (penMaxSize - minStrokeWidth);
        const currentInkStyle = { color: trailColor, diameter: pressureDiameter };
        const currentEraserStyle = { color: 'white', diameter: eraserSize };
        (await presenter).updateInkTrailStartPoint(evt, isErasing ? currentEraserStyle : currentInkStyle);
      }
    });

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
  </script>
</body>
</html>
