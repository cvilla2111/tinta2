<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Canvas</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #fff;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }

    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: crosshair;
      touch-action: none;
    }

    /* Minimal toolbar - appears on hover at top */
    .toolbar {
      position: fixed;
      top: -50px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      padding: 10px 16px;
      background: rgba(30, 30, 30, 0.9);
      border-radius: 0 0 12px 12px;
      backdrop-filter: blur(10px);
      transition: top 0.3s ease;
      z-index: 100;
    }

    .toolbar:hover,
    .toolbar.visible {
      top: 0;
    }

    /* Hover zone to trigger toolbar */
    .toolbar-trigger {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 20px;
      z-index: 99;
    }

    .toolbar-trigger:hover + .toolbar,
    .toolbar-trigger:hover ~ .toolbar {
      top: 0;
    }

    .btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      font-size: 16px;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .btn.active {
      background: rgba(255, 255, 255, 0.3);
    }

    .color-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: transform 0.15s, border-color 0.15s;
    }

    .color-btn:hover {
      transform: scale(1.15);
    }

    .color-btn.active {
      border-color: #fff;
    }

    .separator {
      width: 1px;
      background: rgba(255, 255, 255, 0.2);
      margin: 0 4px;
    }

    .size-indicator {
      color: rgba(255, 255, 255, 0.7);
      font-size: 11px;
      font-family: system-ui, sans-serif;
      min-width: 28px;
      text-align: center;
      align-self: center;
    }

    /* Eraser cursor indicator */
    .eraser-cursor {
      position: fixed;
      border: 2px solid rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      pointer-events: none;
      z-index: 1000;
      display: none;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.2);
    }

    .eraser-cursor.visible {
      display: block;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <div class="eraser-cursor" id="eraserCursor"></div>

  <div class="toolbar-trigger"></div>
  <div class="toolbar" id="toolbar">
    <!-- Colors -->
    <button class="color-btn active" style="background: #1a1a1a;" data-color="#1a1a1a" title="Black"></button>
    <button class="color-btn" style="background: #e74c3c;" data-color="#e74c3c" title="Red"></button>
    <button class="color-btn" style="background: #3498db;" data-color="#3498db" title="Blue"></button>
    <button class="color-btn" style="background: #27ae60;" data-color="#27ae60" title="Green"></button>

    <div class="separator"></div>

    <!-- Size controls -->
    <button class="btn" id="sizeDown" title="Smaller">−</button>
    <span class="size-indicator" id="sizeDisplay">2</span>
    <button class="btn" id="sizeUp" title="Larger">+</button>

    <div class="separator"></div>

    <!-- Tools -->
    <button class="btn" id="eraserBtn" title="Eraser">⌫</button>
    <button class="btn" id="clearBtn" title="Clear All">✕</button>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', {
      willReadFrequently: false,
      desynchronized: true
    });

    // State
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    let lastPressure = 0.5;
    let strokeColor = '#1a1a1a';
    let baseSize = 2;
    let isEraser = false;
    let activeEraser = false; // True during stroke if using eraser tip or eraser tool

    // Speed-based eraser size boost
    let eraserSizeMultiplier = 1; // 1 = normal, 2 = boosted
    let lastEraseX = 0;
    let lastEraseY = 0;
    let lastEraseTime = 0;
    let fastSampleCount = 0; // Count of consecutive fast speed samples

    // Speed threshold for eraser boost
    const FAST_SPEED_THRESHOLD = 1200; // pixels per second
    const FAST_SAMPLES_REQUIRED = 5; // Must sustain fast speed for this many samples

    // Eraser cursor indicator
    const eraserCursor = document.getElementById('eraserCursor');

    function updateEraserCursor(x, y, show) {
      if (show) {
        const size = (getStrokeWidth(0.5) + 10) * 2 * eraserSizeMultiplier; // Match eraser size with boost
        eraserCursor.style.width = size + 'px';
        eraserCursor.style.height = size + 'px';
        eraserCursor.style.left = x + 'px';
        eraserCursor.style.top = y + 'px';
        eraserCursor.classList.add('visible');
      } else {
        eraserCursor.classList.remove('visible');
      }
    }

    // High DPI support
    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();

      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;

      ctx.scale(dpr, dpr);
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';

      // Canvas is transparent - white background handled by CSS
      ctx.clearRect(0, 0, rect.width, rect.height);
    }

    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    function getPointerPos(e) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top,
        pressure: e.pressure || 0.5
      };
    }

    // Detect if using eraser end of stylus (button 5 or buttons bitmask 32)
    function isEraserTip(e) {
      return e.button === 5 || (e.buttons & 32) !== 0;
    }

    function startStroke(e) {
      // Only allow pen (stylus) input - disable finger/touch
      if (e.pointerType === 'touch') return;

      isDrawing = true;
      activeEraser = isEraser || isEraserTip(e); // Use eraser if tool selected OR using eraser tip

      const pos = getPointerPos(e);
      lastX = pos.x;
      lastY = pos.y;
      lastPressure = pos.pressure;

      // Show eraser cursor
      updateEraserCursor(e.clientX, e.clientY, activeEraser);

      // Initialize speed tracking for eraser
      if (activeEraser) {
        lastEraseX = pos.x;
        lastEraseY = pos.y;
        lastEraseTime = Date.now();
        eraserSizeMultiplier = 1; // Reset on new stroke
        fastSampleCount = 0; // Reset sample counter
        eraserCursor.style.borderColor = 'rgba(0, 0, 0, 0.5)';
      }

      // Set composite operation for eraser (destination-out removes pixels)
      if (activeEraser) {
        ctx.globalCompositeOperation = 'destination-out';
      } else {
        ctx.globalCompositeOperation = 'source-over';
      }

      ctx.beginPath();
      ctx.arc(pos.x, pos.y, getStrokeWidth(pos.pressure) / 2, 0, Math.PI * 2);
      ctx.fillStyle = activeEraser ? 'rgba(0,0,0,1)' : strokeColor;
      ctx.fill();
    }

    function continueStroke(e) {
      if (!isDrawing) return;

      const pos = getPointerPos(e);
      const width = getStrokeWidth(pos.pressure);
      const lastWidth = getStrokeWidth(lastPressure);

      // Update eraser cursor position
      updateEraserCursor(e.clientX, e.clientY, activeEraser);

      // Calculate speed and boost eraser if fast
      if (activeEraser) {
        const now = Date.now();
        const dt = now - lastEraseTime;
        if (dt > 0) {
          const dx = pos.x - lastEraseX;
          const dy = pos.y - lastEraseY;
          const distance = Math.sqrt(dx * dx + dy * dy);
          const speed = (distance / dt) * 1000; // pixels per second

          // Track consecutive fast samples before boosting
          if (speed > FAST_SPEED_THRESHOLD) {
            fastSampleCount++;
            // Boost eraser only after sustained fast speed
            if (fastSampleCount >= FAST_SAMPLES_REQUIRED && eraserSizeMultiplier === 1) {
              eraserSizeMultiplier = 4;
              eraserCursor.style.borderColor = 'rgba(255, 100, 100, 0.8)';
            }
          } else {
            fastSampleCount = 0; // Reset if speed drops
          }

          lastEraseX = pos.x;
          lastEraseY = pos.y;
          lastEraseTime = now;
        }
      }

      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(pos.x, pos.y);
      ctx.strokeStyle = activeEraser ? 'rgba(0,0,0,1)' : strokeColor;
      ctx.lineWidth = activeEraser ? ((width + lastWidth) / 2 + 10) * 2 * eraserSizeMultiplier : (width + lastWidth) / 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.stroke();

      lastX = pos.x;
      lastY = pos.y;
      lastPressure = pos.pressure;
    }

    function endStroke() {
      // Reset eraser size when stylus leaves screen
      if (activeEraser) {
        eraserSizeMultiplier = 1;
        eraserCursor.style.borderColor = 'rgba(0, 0, 0, 0.5)';
      }

      isDrawing = false;
      updateEraserCursor(0, 0, false); // Hide eraser cursor
    }

    function getStrokeWidth(pressure) {
      const minWidth = baseSize * 0.3;
      const maxWidth = baseSize * 2.5;
      return minWidth + (maxWidth - minWidth) * pressure;
    }

    canvas.addEventListener('pointerdown', startStroke);
    canvas.addEventListener('pointermove', (e) => {
      continueStroke(e);
      // Show eraser cursor on hover when eraser tool is selected
      if (!isDrawing && (isEraser || isEraserTip(e))) {
        updateEraserCursor(e.clientX, e.clientY, true);
      } else if (!isDrawing) {
        updateEraserCursor(0, 0, false);
      }
    });
    canvas.addEventListener('pointerup', endStroke);
    canvas.addEventListener('pointerleave', (e) => {
      endStroke();
      updateEraserCursor(0, 0, false); // Hide cursor when leaving canvas
    });
    canvas.addEventListener('pointercancel', endStroke);

    canvas.addEventListener('touchstart', e => e.preventDefault(), { passive: false });
    canvas.addEventListener('touchmove', e => e.preventDefault(), { passive: false });

    // Toolbar
    const toolbar = document.getElementById('toolbar');
    const colorBtns = document.querySelectorAll('.color-btn');
    const sizeDisplay = document.getElementById('sizeDisplay');
    const eraserBtn = document.getElementById('eraserBtn');

    colorBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        colorBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        strokeColor = btn.dataset.color;
        isEraser = false;
        eraserBtn.classList.remove('active');
      });
    });

    document.getElementById('sizeUp').addEventListener('click', () => {
      baseSize = Math.min(20, baseSize + 1);
      sizeDisplay.textContent = baseSize;
    });

    document.getElementById('sizeDown').addEventListener('click', () => {
      baseSize = Math.max(1, baseSize - 1);
      sizeDisplay.textContent = baseSize;
    });

    eraserBtn.addEventListener('click', () => {
      isEraser = !isEraser;
      eraserBtn.classList.toggle('active', isEraser);
      if (isEraser) {
        colorBtns.forEach(b => b.classList.remove('active'));
      } else {
        document.querySelector(`[data-color="${strokeColor}"]`)?.classList.add('active');
      }
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      const rect = canvas.getBoundingClientRect();
      ctx.globalCompositeOperation = 'source-over';
      ctx.clearRect(0, 0, rect.width, rect.height);
    });

    toolbar.addEventListener('pointerdown', e => e.stopPropagation());

    // Keyboard shortcuts
    document.addEventListener('keydown', e => {
      if (e.key === 'e' || e.key === 'E') {
        eraserBtn.click();
      } else if (e.key === 'c' || e.key === 'C') {
        document.getElementById('clearBtn').click();
      } else if (e.key === '[') {
        document.getElementById('sizeDown').click();
      } else if (e.key === ']') {
        document.getElementById('sizeUp').click();
      } else if (e.key >= '1' && e.key <= '4') {
        const idx = parseInt(e.key) - 1;
        if (colorBtns[idx]) colorBtns[idx].click();
      }
    });
  </script>
</body>
</html>
