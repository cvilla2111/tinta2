<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Canvas</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #fff;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }

    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: crosshair;
      touch-action: none;
    }

    /* Minimal toolbar - appears on hover at top */
    .toolbar {
      position: fixed;
      top: -50px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      padding: 10px 16px;
      background: rgba(30, 30, 30, 0.9);
      border-radius: 0 0 12px 12px;
      backdrop-filter: blur(10px);
      transition: top 0.3s ease;
      z-index: 100;
    }

    .toolbar:hover,
    .toolbar.visible {
      top: 0;
    }

    /* Hover zone to trigger toolbar */
    .toolbar-trigger {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 20px;
      z-index: 99;
    }

    .toolbar-trigger:hover + .toolbar,
    .toolbar-trigger:hover ~ .toolbar {
      top: 0;
    }

    .btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      font-size: 16px;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .btn.active {
      background: rgba(255, 255, 255, 0.3);
    }

    .color-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: transform 0.15s, border-color 0.15s;
    }

    .color-btn:hover {
      transform: scale(1.15);
    }

    .color-btn.active {
      border-color: #fff;
    }

    .separator {
      width: 1px;
      background: rgba(255, 255, 255, 0.2);
      margin: 0 4px;
    }

    .size-indicator {
      color: rgba(255, 255, 255, 0.7);
      font-size: 11px;
      font-family: system-ui, sans-serif;
      min-width: 28px;
      text-align: center;
      align-self: center;
    }

    /* Eraser cursor indicator */
    .eraser-cursor {
      position: fixed;
      border: 2px solid rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      pointer-events: none;
      z-index: 1000;
      display: none;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.2);
    }

    .eraser-cursor.visible {
      display: block;
    }

    /* Debug panel */
    .debug-panel {
      position: fixed;
      bottom: 16px;
      left: 16px;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
      padding: 12px;
      border-radius: 8px;
      z-index: 200;
      min-width: 220px;
      line-height: 1.6;
    }

    .debug-panel .title {
      font-weight: bold;
      color: #4af0c8;
      margin-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      padding-bottom: 4px;
    }

    .debug-panel .row {
      display: flex;
      justify-content: space-between;
    }

    .debug-panel .label {
      color: #888;
    }

    .debug-panel .value {
      color: #fff;
      font-weight: bold;
    }

    .debug-panel .value.warning {
      color: #fbbf24;
    }

    .debug-panel .value.triggered {
      color: #ff6b6b;
    }

    .debug-panel .copy-btn {
      margin-top: 10px;
      width: 100%;
      padding: 6px;
      background: #4af0c8;
      color: #000;
      border: none;
      border-radius: 4px;
      font-family: inherit;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
    }

    .debug-panel .copy-btn:hover {
      background: #3dd9b3;
    }

    .debug-panel .copy-btn.copied {
      background: #27ae60;
      color: #fff;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <div class="eraser-cursor" id="eraserCursor"></div>

  <!-- Debug Panel -->
  <div class="debug-panel" id="debugPanel">
    <div class="title">ðŸ”§ Eraser Debug</div>
    <div class="row"><span class="label">Speed:</span><span class="value" id="dbgSpeed">0 px/s</span></div>
    <div class="row"><span class="label">Peak Speed:</span><span class="value" id="dbgPeakSpeed">0 px/s</span></div>
    <div class="row"><span class="label">Time Delta:</span><span class="value" id="dbgDt">0 ms</span></div>
    <div class="row"><span class="label">Distance:</span><span class="value" id="dbgDistance">0 px</span></div>
    <div class="row"><span class="label">Fast Samples:</span><span class="value" id="dbgSamples">0 / 5</span></div>
    <div class="row"><span class="label">Multiplier:</span><span class="value" id="dbgMultiplier">1x</span></div>
    <div class="row"><span class="label">Threshold:</span><span class="value" id="dbgThreshold">1200 px/s</span></div>
    <div class="row"><span class="label">Avg Event Rate:</span><span class="value" id="dbgEventRate">0 Hz</span></div>
    <button class="copy-btn" id="copyDebugBtn">ðŸ“‹ Copy Debug Info</button>
  </div>

  <div class="toolbar-trigger"></div>
  <div class="toolbar" id="toolbar">
    <!-- Colors -->
    <button class="color-btn active" style="background: #1a1a1a;" data-color="#1a1a1a" title="Black"></button>
    <button class="color-btn" style="background: #e74c3c;" data-color="#e74c3c" title="Red"></button>
    <button class="color-btn" style="background: #3498db;" data-color="#3498db" title="Blue"></button>
    <button class="color-btn" style="background: #27ae60;" data-color="#27ae60" title="Green"></button>

    <div class="separator"></div>

    <!-- Size controls -->
    <button class="btn" id="sizeDown" title="Smaller">âˆ’</button>
    <span class="size-indicator" id="sizeDisplay">2</span>
    <button class="btn" id="sizeUp" title="Larger">+</button>

    <div class="separator"></div>

    <!-- Tools -->
    <button class="btn" id="eraserBtn" title="Eraser">âŒ«</button>
    <button class="btn" id="clearBtn" title="Clear All">âœ•</button>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', {
      willReadFrequently: false,
      desynchronized: true
    });

    // State
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    let lastPressure = 0.5;
    let strokeColor = '#1a1a1a';
    let baseSize = 2;
    let isEraser = false;
    let activeEraser = false; // True during stroke if using eraser tip or eraser tool

    // Speed-based eraser size boost
    let eraserSizeMultiplier = 1; // 1 = normal, 2 = boosted
    let lastEraseX = 0;
    let lastEraseY = 0;
    let lastEraseTime = 0;
    let fastSampleCount = 0; // Count of consecutive fast speed samples

    // Speed threshold for eraser boost
    const FAST_SPEED_THRESHOLD = 1200; // pixels per second
    const FAST_SAMPLES_REQUIRED = 5; // Must sustain fast speed for this many samples

    // Debug variables
    let dbgPeakSpeed = 0;
    let dbgEventCount = 0;
    let dbgStartTime = 0;

    // Debug DOM elements
    const dbgSpeedEl = document.getElementById('dbgSpeed');
    const dbgPeakSpeedEl = document.getElementById('dbgPeakSpeed');
    const dbgDtEl = document.getElementById('dbgDt');
    const dbgDistanceEl = document.getElementById('dbgDistance');
    const dbgSamplesEl = document.getElementById('dbgSamples');
    const dbgMultiplierEl = document.getElementById('dbgMultiplier');
    const dbgThresholdEl = document.getElementById('dbgThreshold');
    const dbgEventRateEl = document.getElementById('dbgEventRate');

    // Initialize threshold display
    dbgThresholdEl.textContent = FAST_SPEED_THRESHOLD + ' px/s';

    function updateDebugPanel(speed, dt, distance) {
      // Update current values
      dbgSpeedEl.textContent = Math.round(speed) + ' px/s';
      dbgSpeedEl.className = 'value' + (speed > FAST_SPEED_THRESHOLD ? ' warning' : '');

      // Track peak speed
      if (speed > dbgPeakSpeed) {
        dbgPeakSpeed = speed;
        dbgPeakSpeedEl.textContent = Math.round(dbgPeakSpeed) + ' px/s';
      }

      dbgDtEl.textContent = dt.toFixed(1) + ' ms';
      dbgDistanceEl.textContent = distance.toFixed(1) + ' px';
      dbgSamplesEl.textContent = fastSampleCount + ' / ' + FAST_SAMPLES_REQUIRED;
      dbgSamplesEl.className = 'value' + (fastSampleCount >= FAST_SAMPLES_REQUIRED ? ' triggered' : '');

      dbgMultiplierEl.textContent = eraserSizeMultiplier + 'x';
      dbgMultiplierEl.className = 'value' + (eraserSizeMultiplier > 1 ? ' triggered' : '');

      // Calculate event rate
      dbgEventCount++;
      const elapsed = (Date.now() - dbgStartTime) / 1000;
      if (elapsed > 0) {
        const rate = dbgEventCount / elapsed;
        dbgEventRateEl.textContent = Math.round(rate) + ' Hz';
      }
    }

    function resetDebugPanel() {
      dbgPeakSpeed = 0;
      dbgEventCount = 0;
      dbgStartTime = Date.now();
      dbgSpeedEl.textContent = '0 px/s';
      dbgSpeedEl.className = 'value';
      dbgPeakSpeedEl.textContent = '0 px/s';
      dbgDtEl.textContent = '0 ms';
      dbgDistanceEl.textContent = '0 px';
      dbgSamplesEl.textContent = '0 / ' + FAST_SAMPLES_REQUIRED;
      dbgSamplesEl.className = 'value';
      dbgMultiplierEl.textContent = '1x';
      dbgMultiplierEl.className = 'value';
      dbgEventRateEl.textContent = '0 Hz';
    }

    // Copy debug info to clipboard
    const copyDebugBtn = document.getElementById('copyDebugBtn');
    copyDebugBtn.addEventListener('click', () => {
      const deviceInfo = `Device: ${navigator.userAgent.includes('Surface') ? 'Surface' : 'Unknown'}`;
      const screenInfo = `Screen: ${window.screen.width}x${window.screen.height} @ ${window.devicePixelRatio}x DPR`;
      const debugInfo = `
=== Eraser Debug Info ===
${deviceInfo}
${screenInfo}
Viewport: ${window.innerWidth}x${window.innerHeight}

Speed: ${dbgSpeedEl.textContent}
Peak Speed: ${dbgPeakSpeedEl.textContent}
Time Delta: ${dbgDtEl.textContent}
Distance: ${dbgDistanceEl.textContent}
Fast Samples: ${dbgSamplesEl.textContent}
Multiplier: ${dbgMultiplierEl.textContent}
Threshold: ${dbgThresholdEl.textContent}
Avg Event Rate: ${dbgEventRateEl.textContent}
=========================
      `.trim();

      navigator.clipboard.writeText(debugInfo).then(() => {
        copyDebugBtn.textContent = 'âœ“ Copied!';
        copyDebugBtn.classList.add('copied');
        setTimeout(() => {
          copyDebugBtn.textContent = 'ðŸ“‹ Copy Debug Info';
          copyDebugBtn.classList.remove('copied');
        }, 2000);
      });
    });

    // Eraser cursor indicator
    const eraserCursor = document.getElementById('eraserCursor');

    function updateEraserCursor(x, y, show) {
      if (show) {
        const size = (getStrokeWidth(0.5) + 10) * 2 * eraserSizeMultiplier; // Match eraser size with boost
        eraserCursor.style.width = size + 'px';
        eraserCursor.style.height = size + 'px';
        eraserCursor.style.left = x + 'px';
        eraserCursor.style.top = y + 'px';
        eraserCursor.classList.add('visible');
      } else {
        eraserCursor.classList.remove('visible');
      }
    }

    // High DPI support
    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();

      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;

      ctx.scale(dpr, dpr);
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';

      // Canvas is transparent - white background handled by CSS
      ctx.clearRect(0, 0, rect.width, rect.height);
    }

    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    function getPointerPos(e) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top,
        pressure: e.pressure || 0.5
      };
    }

    // Detect if using eraser end of stylus (button 5 or buttons bitmask 32)
    function isEraserTip(e) {
      return e.button === 5 || (e.buttons & 32) !== 0;
    }

    function startStroke(e) {
      // Only allow pen (stylus) input - disable finger/touch
      if (e.pointerType === 'touch') return;

      isDrawing = true;
      activeEraser = isEraser || isEraserTip(e); // Use eraser if tool selected OR using eraser tip

      const pos = getPointerPos(e);
      lastX = pos.x;
      lastY = pos.y;
      lastPressure = pos.pressure;

      // Show eraser cursor
      updateEraserCursor(e.clientX, e.clientY, activeEraser);

      // Initialize speed tracking for eraser
      if (activeEraser) {
        lastEraseX = pos.x;
        lastEraseY = pos.y;
        lastEraseTime = Date.now();
        eraserSizeMultiplier = 1; // Reset on new stroke
        fastSampleCount = 0; // Reset sample counter
        eraserCursor.style.borderColor = 'rgba(0, 0, 0, 0.5)';
        resetDebugPanel(); // Reset debug on new stroke
      }

      // Set composite operation for eraser (destination-out removes pixels)
      if (activeEraser) {
        ctx.globalCompositeOperation = 'destination-out';
      } else {
        ctx.globalCompositeOperation = 'source-over';
      }

      ctx.beginPath();
      ctx.arc(pos.x, pos.y, getStrokeWidth(pos.pressure) / 2, 0, Math.PI * 2);
      ctx.fillStyle = activeEraser ? 'rgba(0,0,0,1)' : strokeColor;
      ctx.fill();
    }

    function continueStroke(e) {
      if (!isDrawing) return;

      const pos = getPointerPos(e);
      const width = getStrokeWidth(pos.pressure);
      const lastWidth = getStrokeWidth(lastPressure);

      // Update eraser cursor position
      updateEraserCursor(e.clientX, e.clientY, activeEraser);

      // Calculate speed and boost eraser if fast
      if (activeEraser) {
        const now = Date.now();
        const dt = now - lastEraseTime;
        if (dt > 0) {
          const dx = pos.x - lastEraseX;
          const dy = pos.y - lastEraseY;
          const distance = Math.sqrt(dx * dx + dy * dy);
          const speed = (distance / dt) * 1000; // pixels per second

          // Update debug panel
          updateDebugPanel(speed, dt, distance);

          // Track consecutive fast samples before boosting
          if (speed > FAST_SPEED_THRESHOLD) {
            fastSampleCount++;
            // Boost eraser only after sustained fast speed
            if (fastSampleCount >= FAST_SAMPLES_REQUIRED && eraserSizeMultiplier === 1) {
              eraserSizeMultiplier = 4;
              eraserCursor.style.borderColor = 'rgba(255, 100, 100, 0.8)';
            }
          } else {
            fastSampleCount = 0; // Reset if speed drops
          }

          lastEraseX = pos.x;
          lastEraseY = pos.y;
          lastEraseTime = now;
        }
      }

      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(pos.x, pos.y);
      ctx.strokeStyle = activeEraser ? 'rgba(0,0,0,1)' : strokeColor;
      ctx.lineWidth = activeEraser ? ((width + lastWidth) / 2 + 10) * 2 * eraserSizeMultiplier : (width + lastWidth) / 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.stroke();

      lastX = pos.x;
      lastY = pos.y;
      lastPressure = pos.pressure;
    }

    function endStroke() {
      // Reset eraser size when stylus leaves screen
      if (activeEraser) {
        eraserSizeMultiplier = 1;
        eraserCursor.style.borderColor = 'rgba(0, 0, 0, 0.5)';
      }

      isDrawing = false;
      updateEraserCursor(0, 0, false); // Hide eraser cursor
    }

    function getStrokeWidth(pressure) {
      const minWidth = baseSize * 0.3;
      const maxWidth = baseSize * 2.5;
      return minWidth + (maxWidth - minWidth) * pressure;
    }

    canvas.addEventListener('pointerdown', startStroke);
    canvas.addEventListener('pointermove', (e) => {
      continueStroke(e);
      // Show eraser cursor on hover when eraser tool is selected
      if (!isDrawing && (isEraser || isEraserTip(e))) {
        updateEraserCursor(e.clientX, e.clientY, true);
      } else if (!isDrawing) {
        updateEraserCursor(0, 0, false);
      }
    });
    canvas.addEventListener('pointerup', endStroke);
    canvas.addEventListener('pointerleave', (e) => {
      endStroke();
      updateEraserCursor(0, 0, false); // Hide cursor when leaving canvas
    });
    canvas.addEventListener('pointercancel', endStroke);

    canvas.addEventListener('touchstart', e => e.preventDefault(), { passive: false });
    canvas.addEventListener('touchmove', e => e.preventDefault(), { passive: false });

    // Toolbar
    const toolbar = document.getElementById('toolbar');
    const colorBtns = document.querySelectorAll('.color-btn');
    const sizeDisplay = document.getElementById('sizeDisplay');
    const eraserBtn = document.getElementById('eraserBtn');

    colorBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        colorBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        strokeColor = btn.dataset.color;
        isEraser = false;
        eraserBtn.classList.remove('active');
      });
    });

    document.getElementById('sizeUp').addEventListener('click', () => {
      baseSize = Math.min(20, baseSize + 1);
      sizeDisplay.textContent = baseSize;
    });

    document.getElementById('sizeDown').addEventListener('click', () => {
      baseSize = Math.max(1, baseSize - 1);
      sizeDisplay.textContent = baseSize;
    });

    eraserBtn.addEventListener('click', () => {
      isEraser = !isEraser;
      eraserBtn.classList.toggle('active', isEraser);
      if (isEraser) {
        colorBtns.forEach(b => b.classList.remove('active'));
      } else {
        document.querySelector(`[data-color="${strokeColor}"]`)?.classList.add('active');
      }
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      const rect = canvas.getBoundingClientRect();
      ctx.globalCompositeOperation = 'source-over';
      ctx.clearRect(0, 0, rect.width, rect.height);
    });

    toolbar.addEventListener('pointerdown', e => e.stopPropagation());

    // Keyboard shortcuts
    document.addEventListener('keydown', e => {
      if (e.key === 'e' || e.key === 'E') {
        eraserBtn.click();
      } else if (e.key === 'c' || e.key === 'C') {
        document.getElementById('clearBtn').click();
      } else if (e.key === '[') {
        document.getElementById('sizeDown').click();
      } else if (e.key === ']') {
        document.getElementById('sizeUp').click();
      } else if (e.key >= '1' && e.key <= '4') {
        const idx = parseInt(e.key) - 1;
        if (colorBtns[idx]) colorBtns[idx].click();
      }
    });
  </script>
</body>
</html>
